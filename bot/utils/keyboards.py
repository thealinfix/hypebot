"""
Telegram keyboard builders
"""
from typing import List, Optional, Dict, Any, Tuple
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton
import logging

logger = logging.getLogger(__name__)


class KeyboardBuilder:
    """Builder for creating Telegram keyboards"""
    
    @staticmethod
    def main_menu(is_admin: bool = False) -> InlineKeyboardMarkup:
        """Build main menu keyboard"""
        keyboard_buttons = [
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞", callback_data="cmd_status")],
            [InlineKeyboardButton("‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="cmd_help")]
        ]
        
        if is_admin:
            keyboard_buttons.extend([
                [
                    InlineKeyboardButton("üëÅ –ü—Ä–µ–≤—å—é –ø–æ—Å—Ç–æ–≤", callback_data="cmd_preview"),
                    InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–ª–∏–∑—ã", callback_data="cmd_check")
                ],
                [
                    InlineKeyboardButton("üí≠ –°–æ–∑–¥–∞—Ç—å –º—ã—Å–ª–∏", callback_data="cmd_thoughts"),
                    InlineKeyboardButton("‚è∞ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", callback_data="cmd_scheduled")
                ],
                [
                    InlineKeyboardButton("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="cmd_stats"),
                    InlineKeyboardButton("ü§ñ –ê–≤—Ç–æ-–ø—É–±–ª–∏–∫–∞—Ü–∏—è", callback_data="cmd_auto_menu")
                ],
                [
                    InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="cmd_settings"),
                    InlineKeyboardButton("üßπ –û—á–∏—Å—Ç–∫–∞", callback_data="cmd_clean_menu")
                ],
                [
                    InlineKeyboardButton("üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", callback_data="cmd_tools_menu")
                ]
            ])
        
        return InlineKeyboardMarkup(keyboard_buttons)
    
    @staticmethod
    def back_to_main() -> InlineKeyboardMarkup:
        """Simple back to main menu button"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")]
        ])
    
    @staticmethod
    def preview_navigation(current_idx: int, total: int, post_id: str, 
                          is_favorite: bool = False) -> InlineKeyboardMarkup:
        """Build preview navigation keyboard"""
        keyboard_buttons = []
        
        # Navigation buttons
        nav_buttons = []
        if current_idx > 0:
            nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=f"preview_prev:{current_idx}"))
        nav_buttons.append(InlineKeyboardButton(f"{current_idx + 1}/{total}", callback_data="noop"))
        if current_idx < total - 1:
            nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", callback_data=f"preview_next:{current_idx}"))
        
        keyboard_buttons.append(nav_buttons)
        
        # Action buttons
        keyboard_buttons.append([
            InlineKeyboardButton("üëÅ –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä", callback_data=f"preview_full:{post_id}"),
            InlineKeyboardButton("‚≠êÔ∏è" if is_favorite else "‚òÜ", callback_data=f"toggle_fav:{post_id}")
        ])
        
        keyboard_buttons.append([
            InlineKeyboardButton("üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–æ–∂–∫—É", callback_data=f"gen_cover:{post_id}"),
            InlineKeyboardButton("‚è∞ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"schedule:{post_id}")
        ])
        
        keyboard_buttons.append([
            InlineKeyboardButton("üè∑ –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º", callback_data="filter_tags"),
            InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="preview_close")
        ])
        
        keyboard_buttons.append([
            InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="cmd_back_main")
        ])
        
        return InlineKeyboardMarkup(keyboard_buttons)
    
    @staticmethod
    def moderation(post_id: str) -> InlineKeyboardMarkup:
        """Build moderation keyboard"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", callback_data=f"approve:{post_id}")],
            [InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç", callback_data=f"regen:{post_id}")],
            [
                InlineKeyboardButton("üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–æ–∂–∫—É", callback_data=f"gen_cover_full:{post_id}"),
                InlineKeyboardButton("‚úèÔ∏è –°–≤–æ–π –ø—Ä–æ–º–ø—Ç", callback_data=f"custom_prompt:{post_id}")
            ],
            [
                InlineKeyboardButton("‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª", callback_data=f"revert_img:{post_id}"),
                InlineKeyboardButton("‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data=f"reject:{post_id}")
            ],
            [
                InlineKeyboardButton("‚óÄÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–≤—å—é", callback_data=f"back_preview:{post_id}"),
                InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="cmd_back_main")
            ]
        ])
    
    @staticmethod
    def thoughts_actions(has_image: bool = False) -> InlineKeyboardMarkup:
        """Build thoughts action keyboard"""
        buttons = [
            [InlineKeyboardButton("üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", callback_data="publish_thought")],
            [InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", callback_data="regen_thought")],
            [InlineKeyboardButton("üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±–ª–æ–∂–∫—É", callback_data="gen_thought_cover")],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_thought")]
        ]
        
        if has_image:
            buttons.insert(2, [InlineKeyboardButton("üñº –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", callback_data="remove_thought_image")])
        
        return InlineKeyboardMarkup(buttons)
    
    @staticmethod
    def settings_menu() -> InlineKeyboardMarkup:
        """Build settings menu keyboard"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üì¢ –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞–Ω–∞–ª", callback_data="settings_channel")],
            [InlineKeyboardButton("üïê –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –∑–æ–Ω—É", callback_data="settings_timezone")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")]
        ])
    
    @staticmethod
    def timezone_selection() -> InlineKeyboardMarkup:
        """Build timezone selection keyboard"""
        from bot.utils.time_utils import get_timezone_list
        
        keyboard_buttons = []
        for name, tz in get_timezone_list():
            callback_data = f"tz_{tz.replace('/', '_')}"
            keyboard_buttons.append([InlineKeyboardButton(name, callback_data=callback_data)])
        
        keyboard_buttons.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="cmd_settings")])
        
        return InlineKeyboardMarkup(keyboard_buttons)
    
    @staticmethod
    def clean_menu() -> InlineKeyboardMarkup:
        """Build clean menu keyboard"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üóë –°—Ç–∞—Ä—ã–µ –ø–æ—Å—Ç—ã", callback_data="clean_old")],
            [InlineKeyboardButton("üìù –û—á–µ—Ä–µ–¥—å –ø–æ—Å—Ç–æ–≤", callback_data="clean_pending")],
            [InlineKeyboardButton("‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ", callback_data="clean_sent")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")]
        ])
    
    @staticmethod
    def tools_menu() -> InlineKeyboardMarkup:
        """Build tools menu keyboard"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üîç –¢–µ—Å—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤", callback_data="tool_test_sources")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")]
        ])
    
    @staticmethod
    def auto_publish_menu(is_enabled: bool, interval_minutes: int) -> InlineKeyboardMarkup:
        """Build auto-publish menu keyboard"""
        toggle_text = "üî¥ –í—ã–∫–ª—é—á–∏—Ç—å" if is_enabled else "üü¢ –í–∫–ª—é—á–∏—Ç—å"
        
        return InlineKeyboardMarkup([
            [InlineKeyboardButton(toggle_text, callback_data="auto_toggle")],
            [
                InlineKeyboardButton("30 –º–∏–Ω", callback_data="auto_interval:1800"),
                InlineKeyboardButton("1 —á–∞—Å", callback_data="auto_interval:3600"),
                InlineKeyboardButton("2 —á–∞—Å–∞", callback_data="auto_interval:7200")
            ],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")]
        ])
    
    @staticmethod
    def scheduled_posts(posts: List[Tuple[str, Dict[str, Any]]]) -> InlineKeyboardMarkup:
        """Build scheduled posts keyboard"""
        keyboard_buttons = []
        
        for post_id, _ in posts:
            keyboard_buttons.append([
                InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å", callback_data=f"edit_schedule:{post_id}"),
                InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"delete_schedule:{post_id}")
            ])
        
        keyboard_buttons.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="cmd_back_main")])
        
        return InlineKeyboardMarkup(keyboard_buttons)
    
    @staticmethod
    def filter_tags(tags: Dict[str, List[str]]) -> InlineKeyboardMarkup:
        """Build tag filter keyboard"""
        keyboard_buttons = []
        
        # Brand buttons
        if tags.get("brands"):
            brand_buttons = []
            for brand in sorted(tags["brands"])[:3]:
                brand_buttons.append(
                    InlineKeyboardButton(
                        brand.title(), 
                        callback_data=f"filter_brand:{brand}"
                    )
                )
            if brand_buttons:
                keyboard_buttons.append(brand_buttons)
        
        # Model buttons
        if tags.get("models"):
            model_buttons = []
            for model in sorted(tags["models"])[:3]:
                model_buttons.append(
                    InlineKeyboardButton(
                        model.upper(), 
                        callback_data=f"filter_model:{model}"
                    )
                )
            if model_buttons:
                keyboard_buttons.append(model_buttons)
        
        # Type buttons
        if tags.get("types"):
            type_buttons = []
            for rtype in sorted(tags["types"])[:3]:
                type_buttons.append(
                    InlineKeyboardButton(
                        rtype.title(), 
                        callback_data=f"filter_type:{rtype}"
                    )
                )
            if type_buttons:
                keyboard_buttons.append(type_buttons)
        
        keyboard_buttons.extend([
            [InlineKeyboardButton("üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã", callback_data="filter_reset")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="preview_close")]
        ])
        
        return InlineKeyboardMarkup(keyboard_buttons)
    
    @staticmethod
    def yes_no(callback_prefix: str) -> InlineKeyboardMarkup:
        """Simple yes/no keyboard"""
        return InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"{callback_prefix}_yes"),
                InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data=f"{callback_prefix}_no")
            ]
        ])
    
    @staticmethod
    def cancel() -> InlineKeyboardMarkup:
        """Simple cancel button"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
        ])
    
    @staticmethod
    def pagination(items: List[Any], page: int, per_page: int = 10, 
                  callback_prefix: str = "page") -> Tuple[List[Any], Optional[InlineKeyboardMarkup]]:
        """Build paginated keyboard"""
        total_pages = (len(items) + per_page - 1) // per_page
        
        if total_pages <= 1:
            return items, None
        
        start_idx = page * per_page
        end_idx = min(start_idx + per_page, len(items))
        page_items = items[start_idx:end_idx]
        
        buttons = []
        
        # Page navigation
        nav_buttons = []
        if page > 0:
            nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è", callback_data=f"{callback_prefix}:{page-1}"))
        
        nav_buttons.append(InlineKeyboardButton(f"{page+1}/{total_pages}", callback_data="noop"))
        
        if page < total_pages - 1:
            nav_buttons.append(InlineKeyboardButton("‚ñ∂Ô∏è", callback_data=f"{callback_prefix}:{page+1}"))
        
        buttons.append(nav_buttons)
        
        return page_items, InlineKeyboardMarkup(buttons)


def remove_keyboard() -> ReplyKeyboardMarkup:
    """Remove reply keyboard"""
    return ReplyKeyboardMarkup([[]], resize_keyboard=True, one_time_keyboard=True)
